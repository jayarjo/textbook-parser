# Docker Compose for Textbook Parser Pipeline
# Multi-container setup for production use

services:
  # All-in-one service (default)
  textbook-parser:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: textbook-parser:latest
    container_name: textbook-parser
    volumes:
      - ./output:/app/output
      - ./config:/app/config
      - ./.env:/app/.env
    environment:
      - PYTHONUNBUFFERED=1
    command: python main.py --config config/default_config.yaml
    networks:
      - parser-network

  # Individual service containers (optional, for scaling)

  # Image Retriever service
  retriever:
    build:
      context: .
      dockerfile: docker/Dockerfile.retriever
    image: textbook-parser-retriever:latest
    container_name: retriever
    ports:
      - "8001:8001"
    volumes:
      - shared-data:/data
      - ./config:/app/config
    environment:
      - PYTHONUNBUFFERED=1
      - PLAYWRIGHT_BROWSERS_PATH=/home/parser/.cache/ms-playwright
    networks:
      - parser-network
    profiles:
      - multi-container

  # Layout Analyzer service
  layout-analyzer:
    build:
      context: .
      dockerfile: docker/Dockerfile.layout-analyzer
    image: textbook-parser-layout:latest
    container_name: layout-analyzer
    ports:
      - "8002:8002"
    volumes:
      - shared-data:/data
      - ./config:/app/config
    environment:
      - PYTHONUNBUFFERED=1
    # Uncomment for GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    networks:
      - parser-network
    profiles:
      - multi-container

  # Image Processor service
  image-processor:
    build:
      context: .
      dockerfile: docker/Dockerfile.image-processor
    image: textbook-parser-processor:latest
    container_name: image-processor
    ports:
      - "8003:8003"
    volumes:
      - shared-data:/data
      - ./config:/app/config
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - parser-network
    profiles:
      - multi-container

  # OCR Engine service
  ocr-engine:
    build:
      context: .
      dockerfile: docker/Dockerfile.ocr
    image: textbook-parser-ocr:latest
    container_name: ocr-engine
    ports:
      - "8004:8004"
    volumes:
      - shared-data:/data
      - ./config:/app/config
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - parser-network
    profiles:
      - multi-container

  # SVG Text Processor service
  svg-processor:
    build:
      context: .
      dockerfile: docker/Dockerfile.svg
    image: textbook-parser-svg:latest
    container_name: svg-processor
    ports:
      - "8007:8007"
    volumes:
      - shared-data:/data
      - ./config:/app/config
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - parser-network
    profiles:
      - multi-container

  # Illustration Interpreter service
  illustration-interpreter:
    build:
      context: .
      dockerfile: docker/Dockerfile.interpreter
    image: textbook-parser-interpreter:latest
    container_name: illustration-interpreter
    ports:
      - "8005:8005"
    volumes:
      - shared-data:/data
      - ./config:/app/config
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - parser-network
    profiles:
      - multi-container

  # NotebookLM Integration service
  notebook-integration:
    build:
      context: .
      dockerfile: docker/Dockerfile.notebook
    image: textbook-parser-notebook:latest
    container_name: notebook-integration
    ports:
      - "8006:8006"
    volumes:
      - shared-data:/data
      - ./output:/app/output
      - ./config:/app/config
      # Mount browser user data for persistent login
      - notebook-browser-data:/home/parser/.local/share/playwright
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - parser-network
    profiles:
      - multi-container
    # Use shared memory for Chromium
    shm_size: '2gb'

  # Orchestrator service (coordinates other services)
  orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.orchestrator
    image: textbook-parser-orchestrator:latest
    container_name: orchestrator
    ports:
      - "8000:8000"
    volumes:
      - shared-data:/data
      - ./output:/app/output
      - ./config:/app/config
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - RETRIEVER_URL=http://retriever:8001
      - LAYOUT_ANALYZER_URL=http://layout-analyzer:8002
      - IMAGE_PROCESSOR_URL=http://image-processor:8003
      - OCR_ENGINE_URL=http://ocr-engine:8004
      - SVG_PROCESSOR_URL=http://svg-processor:8007
      - INTERPRETER_URL=http://illustration-interpreter:8005
      - NOTEBOOK_URL=http://notebook-integration:8006
    depends_on:
      - retriever
      - layout-analyzer
      - image-processor
      - ocr-engine
      - svg-processor
      - illustration-interpreter
      - notebook-integration
    networks:
      - parser-network
    profiles:
      - multi-container

volumes:
  shared-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data
  notebook-browser-data:
    driver: local

networks:
  parser-network:
    driver: bridge
